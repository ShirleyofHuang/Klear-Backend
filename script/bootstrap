
#!/usr/bin/env bash

# Exit immediately if any subcommand fails
set -ea

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"

if [[ $OSTYPE == 'darwin'* ]]; then
  DIR="$DIR/.."
fi

# Install Homebrew
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# Install Brewfile dependencies
cd "$DIR"
pwd

if [ "$(uname -s)" = "Darwin" ]; then # Check if is used on MacOS
  brew bundle check >/dev/null 2>&1  || {  # Check if there is anything to install or upgrade in the Brewfile, output the error to stdout
    echo "==> Installing Homebrew dependencies…"
    brew bundle
  }
fi

# python dependencies
echo "Installing Python"
if [ "$(uname)" == "Darwin" ]; then
brew install python3
pip install numpy
pip install imutils
pip install opencv-python
pip install base64
pip install argparse
pip install IPython
pip install tqdm
pip install subprocess
pip install requests
pip install datetime
pip install python-dotenv
pip install pathlib
pip install django-imagekit
pip install imagekitio
else
sudo apt-get update
sudo apt-get install python3
pip install numpy
pip install imutils
pip install opencv-python
pip install base64
pip install argparse
pip install IPython
pip install tqdm
pip install subprocess
pip install requests
pip install datetime
pip install python-dotenv
pip install pathlib
pip install django-imagekit
pip install imagekitio
fi

# Install npm dependencies
echo "==> Installing npm dependencies…"
npm install

# Make default .env if .env does not exist
echo "==> Updating .env variables"
cd ..
if [ ! -f .env ]
then
  cp -rn .env.template .env
fi

# Make default dev.json if it does not exist
echo "==> Updating dev.json"
if [ ! -f database/config/dev.json ]
then
  source .env
  echo "{
    \"dev\": {
        \"host\": \"${MYSQL_HOST}\", 
        \"user\": \"${MYSQL_USER}\",
        \"password\": \"${MYSQL_PASSWORD}\",
        \"database\": \"${MYSQL_DATABASE}\",
        \"driver\": \"mysql\",
        \"multipleStatements\": true
    }, \"sql-file\": true
}" >  ./database/config/dev.json
fi

# Run DB Migrations
echo "==> Running DB Migration, Please make sure you have the DB as specified in your .env"
db-migrate up --config ./database/config/dev.json